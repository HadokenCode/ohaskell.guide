# Stackage

В предыдущей главе мы познакомились с Hackage, репозиторием Haskell-пакетов. Теперь же настало время познакомится со "стабильным Hackage".

## Проблема

В станодавние времена существовала в мире Haskell большая проблема, связанная с пакетами, и называлась она "dependency hell". Вот в чём её суть.

Как вы уже поняли, каждый из Haskell-пакетов тоже имеет ряд зависимостей от неких других пакетов, и эти зависимости перечислены в его `.cabal`-файле. Зависимость может быть указана "версионной вилкой", например:

```bash
  http-client  >= 0.3 && < 0.5
```

Это означает, что данный пакет зависит от пакета `http-client` любой версии, входящей в промежуток от `0.3` включительно до `0.5`. Однако зависимость может быть указана точно:

```bash
  http-client  == 0.3.6.1
```

В этом случае нам нужна версия `0.3.6.1` и никакая другая. Вот тут-то нас и поджидает ад.

Допустим, наш проект зависит от двух пакетов, `A` и `B`, каждый из которых в свою очередь зависит от третьего пакета `C`. Но к сожалению, звёзды оказались неблагосклонны к нашему проекту, и выяснилось, что пакет `A` зависит от пакета `C` версии `1.8.1`, в то время как пакет `B` - от пакета `C` версии `2.0.0`... Эту проблему пытались решить несколькими способами, но самым удобным оказался способ под названием `Stackage`.

## Что это такое?

Название Stackage происходит от слияния слов "Stable" и "Hackage". Идея в том, чтобы предоставить разработчику надёжный набор пакетов, на который гарантированно можно положиться.

В основе этой идеи лежит LTS Haskell snapshot, или LTS-снимок (от Long-Term Support). LTS-снимок представляет собой большой список пакетов жёстко заданных версий. И подобраны эти версии таким образом, чтобы все пакеты были версионно совместимы друг с другом. Гарантированно и железобетонно. То есть, возвращаясь к нашему примеру, если в LTS-снимке перечислены пакеты `A` и `B`, то их версии подобраны так, чтобы они зависели от одной и той же версии пакета `C`. В этом случае у нас никогда не возникнет никаких версионных коллизий.

Откроем файл `stack.yaml` в корне нашего проекта и найдём там строчку вида:

```yaml
resolver: lts-5.2
```

В этой строке мы задаём номер LTS-снимка, используемого в данном проекте. Да, у каждого снимка есть собственный номер, или, если хотите, версия. В данном случае мы объявляем, что наш проект "живёт" в рамках LTS-снимка под номером `5.2`. Это означает, что если наш проект зависит от пакета `text`, то не от абы какой версии `text`, но именно от версии `1.2.2.0`, ведь именно эта версия упомянута в данном LTS-снимке.

Кстати, содержимое снимка `5.2` можно посмотреть [здесь](https://www.stackage.org/lts-5.2). В конце адреса меняем номер - и видим содержимое другого снимка.

## Неизменность

LTS-снимки хороши и тем, что неизменны. В упомянутом снимке `5.2` перечислены 1766 пакетов конкретных версий, и так оно будет всегда. Следовательно, если члены команды Haskell-разработчиков, работающие на одним и тем же проектом, используют один и тот же снимок - у всех у них всё будет компилироваться. Сегодня, завтра и через пять лет. Создатели Stackage провозгласили это одним из девизов данной идеи: "То, что работает сегодня, должно работать и завтра".

## Утилита stack?

Да, совершенно верно: уже знакомая нам утилита `stack` является частью проекта Stackage, оттого и схожесть в названии. Поэтому, используя `stack`, вы уже используете какой-то LTS-снимок.

## А если не из репозитория?

В самом деле, представим себе такую ситуацию. Некий разработчик сделал полезную Haskell-библиотеку, но не стал включать её в единый репозиторий, а вместо этого поселил её в своём GitHub-профиле. А нам эта библиотека очень уж приглянулась. Как же включить её в проект? Открываем `stack.yaml` и пишем:

```yaml
- location:
    git: https://github.com/user/project.git
    commit: 018919f43854b1d6f30d4270f5471db807ac1a41
```

Думаю, тут всё понятно без комментариев: пакет будет вытянут из данного репозитория (с использованием указанного коммита), собран и включён в наш проект. И не забудьте включить имя данного пакета в списке зависимостей в `.cabal`-файле.

## Ещё почитать

Я написал небольшую [обзорную статью](http://ruhaskell.org/posts/utils/2015/07/13/from-cabal-to-stack.html), посвящённую `stack` и работе с LTS-снимками.
